<html>
  <head>
    <meta charset="utf-8">
    <!-- For Responsive mobile -->
     <meta name="viewport" content="width=device-width, initial-scale=1">
     <link rel="shortcut icon" type="image/jpg" href="img/logo.png" />
     <link rel="stylesheet" href="css/bootstrap.min.css" >
     <link rel="stylesheet" type="text/css" href="fonts/Linearicons-Free-v1.0.0/icon-font.min.css">
     <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/rateYo/2.3.2/jquery.rateyo.min.css">
     <link rel="stylesheet" href="css/all.min.css">
     <link rel="stylesheet" href="css/profile.css"> 
</head>
    <body>
       
      <section class="container">
        <section class="row myProfile p-2 mx-1">
            <div class="col-sm-11">
                <h1>My Profile</h1>
            </div>
        </section>
        <section class="row con py-4 ">
            <section class="contentLeft col-sm-3">
                <p class="border-bottom p-2" id="editp">Edit Profile</p>
                <p class="border-bottom p-2" id="comments">Comments</p>
                <p class="border-bottom p-2" id="bioInput">Bio</p>
                <p class="border-bottom p-2" id="dailyp">Daily Reservations</p>
            </section>
            <section id="profileContent" class="border-start contentRight col-sm-7 d-flex">
                <form class="row g-3">
                  <h2 style="font-weight: bold">Edit Profile</h2><br>
                  
                    <div class="imgs m-auto">
                        <img src="" id="docimage"alt="doctor" class="doctor">
                        <input type="file" id="images">
                        <label for="images">i</label>
                    </div>
                    <div class="col-12">
                        <label for="inputAddress" class="form-label">FullName</label>
                        <input type="text" class="form-control" id="namep">
                      </div>
                    <div class="col-md-6">
                      <label for="inputEmail4" class="form-label">Email</label>
                      <input type="email" class="form-control" id="emailp">
                    </div>
                    <div class="col-md-6">
                      <label for="inputPassword4" class="form-label">Password</label>
                      <input type="password" class="form-control" id="inputPassword4">
                    </div>
                    <div class="col-12">
                      <label for="inputAddress" class="form-label">Address</label>
                      <input type="text" class="form-control" id="inputAddress">
                    </div>
                    <div class="col-md-4">
                        <label for="inputCity" class="form-label">Age</label>
                        <input type="number" class="form-control" id="agep">
                      </div>
                    <div class="col-md-4">
                        <label for="inputCity" class="form-label">DaysOfWork</label>
                        <input type="text" class="form-control" id="daysfwork">
                      </div>
                      <div class="col-md-4">
                        <label for="inputState" class="form-label">Price</label>
                        <input type="number" class="form-control" id="pricep">
                      </div>
                    <div class="col-md-4">
                      <label for="inputCity" class="form-label">Phone</label>
                      <input type="number" class="form-control" id="phonep">
                    </div>
                    <div class="col-md-4">
                      <label for="inputState" class="form-label">StartTime</label>
                      <input type="time" class="form-control" id="st">
                    </div>
                    <div class="col-md-4">
                      <label for="inputZip" class="form-label">EndTime</label>
                      <input type="time" class="form-control" id="et">
                    </div>
                    <div class="col-12">
                      <button type="button" class="btn" id="update">Update</button>
                    </div>
                  </form>
            </section>
            <section id="profileComment" class="comment contentRight col-sm-7 border-start d-none">
              <form action="">
                <h3 style="font-weight: bold" >FeedBack</h3>
                <br>
                <div class="comments w-100">
                </div>
              </form>
              <!-- <h1 class=" d-block">Comments</h1><br> -->
              
            </section>
            <section id="profileDaily" class="dailyReservations contentRight col-sm-7 border-start d-none ">
                <form action="">
                  <h3 style="font-weight: bold">Daily Reservations</h3><br>
                  
                  <div id="Allreservations" class="w-100">
                  </div>
                </form>
                
            </section>
            <section id="profileDaily" class="dailyReservations contentRight col-sm-7 border-start d-none ">
              <form action="">
                <h3 style="font-weight: bold">Daily Reservations</h3><br>
                
            <div id="Allreservations" class="w-100" data-aos="fade-up">
            </div>
              </form>
               
                
            </section>
            <section id="bio" class="contentRight col-sm-8 border-start d-none">
              <form action="">
                <h3 style="font-weight: bold">Your Bio  </h3>
                <br><br>
                <label style="font-size: 19px">Bio</label>
                <br>
                <input type="text" class="form-control" id="bioValue"  style="width: 250px; height: 50px;" placeholder="Your New Bio">
                <br><br>
                  
                <button type="button" class="btn btn-primary" id="bioChange">Save Changes</button>
              </form>
             
            </section>
        </section>
    </section>
        <!-- <script src="js/profile.js"></script> -->
        <script type="module">
         // Import the functions you need from the SDKs you need
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.8/firebase-app.js";
      import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.6.8/firebase-analytics.js";
      import {
        getAuth,
        createUserWithEmailAndPassword,
        updateEmail,
        updatePassword 
      } from "https://www.gstatic.com/firebasejs/9.6.8/firebase-auth.js";
      // TODO: Add SDKs for Firebase products that you want to use
      // https://firebase.google.com/docs/web/setup#available-libraries
      import { getDatabase } from 'https://www.gstatic.com/firebasejs/9.6.8/firebase-database.js'
      import {
        getFirestore,
        doc,
        getDoc,
        setDoc,
        collection,
        addDoc,
        updateDoc ,serverTimestamp,query,where,getDocs
      } from "https://www.gstatic.com/firebasejs/9.6.8/firebase-firestore.js";
      import {
        getStorage, uploadBytesResumable, getDownloadURL
      } from "https://www.gstatic.com/firebasejs/9.6.8/firebase-storage.js";
      import { onSnapshot ,orderBy} from "https://www.gstatic.com/firebasejs/9.6.8/firebase-firestore.js";
      const firebaseConfig = {
        apiKey: "AIzaSyBt4dnGARtW0fnugmHOopbNZyI9rfglz80",
        authDomain: "graduation-project-a1c89.firebaseapp.com",
        databaseURL:
          "https://graduation-project-a1c89-default-rtdb.firebaseio.com",
        projectId: "graduation-project-a1c89",
        storageBucket: "graduation-project-a1c89.appspot.com",
        messagingSenderId: "742395953187",
        appId: "1:742395953187:web:48576f2e94aca323b9f196",
        measurementId: "G-C6SSJZYJ0D",
      };
      const app = initializeApp(firebaseConfig);
      const analytics = getAnalytics(app);
      const db = getFirestore(app);
      const auth = getAuth(app);
      const storage = getStorage(app);
      const database = getDatabase(app);
      var idDoctor = localStorage.getItem("uIdDoctor");
      const q = query(collection(db, "doctor"), where("uId","==", idDoctor));
      const querySnapshot = await getDocs(q);
      querySnapshot.forEach((doc) => 
      {
        document.getElementById('namep').value = doc.data().fullName;
        document.getElementById('emailp').value = doc.data().email;
        document.getElementById('inputAddress').value = doc.data().address;
        document.getElementById('agep').value = doc.data().age;
        document.getElementById('daysfwork').value = doc.data().daysOfWork;
        document.getElementById('pricep').value = doc.data().price;
        document.getElementById('phonep').value = doc.data().phone;
        document.getElementById('st').value = doc.data().startTime;
        document.getElementById('et').value = doc.data().endTime;
        document.getElementById('docimage').src = doc.data().image;
        document.getElementById('bioValue').value = doc.data().certificates;
      });  
document.getElementById("bioChange").addEventListener("click",async function(){
  const docRef = doc(db, 'doctor', idDoctor );
  const updateTimestamp = await updateDoc(docRef, {
  "certificates":document.getElementById('bioValue').value  
}).then(() =>
  {
    alert("Bio updated successfully");
  });

})     
document.getElementById("update").addEventListener("click",async function(){
  updateEmail(auth.currentUser, document.getElementById('emailp').value).then(() => {
  alert("Email updated!")
    }).catch((error) => {
   alert(error);
  });
    const docRef = doc(db, 'doctor', idDoctor );
    const updateTimestamp = await updateDoc(docRef, {
    timestamp: serverTimestamp(),
    "fullName":document.getElementById('namep').value,
    "email":document.getElementById('emailp').value,
    "address":document.getElementById('inputAddress').value ,
    "age":document.getElementById('agep').value ,
    "daysOfWork":document.getElementById('daysfwork').value ,
    "price":document.getElementById('pricep').value ,
    "phone":document.getElementById('phonep').value,
    "startTime":document.getElementById('st').value,
    "endTime":document.getElementById('et').value,
    // "image":document.getElementById('docimage').src;
}).then(() =>
  {
    alert("Data updated successfully");
  });
 })

 document.getElementById("editp").addEventListener("click",function(){
  document.getElementById("editp").classList.add('activbar');
  document.getElementById("comments").classList.remove('activbar');
  document.getElementById("dailyp").classList.remove('activbar');
  document.getElementById("bioInput").classList.remove('activbar');
  document.getElementById("profileContent").classList.replace('d-none' , 'd-flex');
  document.getElementById("profileDaily").classList.replace('d-flex' , 'd-none');
  document.getElementById("profileComment").classList.replace('d-flex' , 'd-none');
  document.getElementById("bio").classList.replace('d-flex' , 'd-none');
})
document.getElementById("comments").addEventListener("click",function(){
  document.getElementById("editp").classList.remove('activbar');
  document.getElementById("comments").classList.add('activbar');
  document.getElementById("dailyp").classList.remove('activbar');
  document.getElementById("bioInput").classList.remove('activbar');
  document.getElementById("profileContent").classList.replace('d-flex' , 'd-none');
  document.getElementById("profileDaily").classList.replace('d-flex' , 'd-none');
  document.getElementById("profileComment").classList.replace('d-none' , 'd-flex');
  document.getElementById("bio").classList.replace('d-flex' , 'd-none');
})
document.getElementById("dailyp").addEventListener("click",function(){
  document.getElementById("editp").classList.remove('activbar');
  document.getElementById("comments").classList.remove('activbar');
  document.getElementById("dailyp").classList.add('activbar');
  document.getElementById("bioInput").classList.remove('activbar');
  document.getElementById("profileContent").classList.replace('d-flex' , 'd-none');
  document.getElementById("profileDaily").classList.replace('d-none' , 'd-flex');
  document.getElementById("profileComment").classList.replace('d-flex' , 'd-none');
  document.getElementById("bio").classList.replace('d-flex' , 'd-none');
});
document.getElementById("bioInput").addEventListener("click",function(){
  document.getElementById("editp").classList.remove('activbar');
  document.getElementById("comments").classList.remove('activbar');
  document.getElementById("bioInput").classList.add('activbar');
  document.getElementById("dailyp").classList.remove('activbar');
  document.getElementById("bio").classList.replace('d-none' , 'd-flex');
  document.getElementById("profileContent").classList.replace('d-flex' , 'd-none');
  document.getElementById("profileDaily").classList.replace('d-flex' , 'd-none');
  document.getElementById("profileComment").classList.replace('d-flex' , 'd-none');
});
/////////////////////////comments
var count=0;                    //rate,comment,name,birthday,time
function data_of_comments(rate,content,date){
  var perant=document.querySelector(".comments");
  var div0=document.createElement("div");
  var div1=document.createElement("div");
  var div2=document.createElement("div");
  var div3=document.createElement("div");
  var div4=document.createElement("div");
  var div5=document.createElement("div");
  var div6=document.createElement("div");
  var div7=document.createElement("div");
  var div8=document.createElement("div");
  var div9=document.createElement("div");
  var div10=document.createElement("div");
  var div11=document.createElement("div");

  var span0=document.createElement("span");
  var span1=document.createElement("span");
  var span2=document.createElement("span");
  var span3=document.createElement("span");
  var span4=document.createElement("span");

  var p0=document.createElement("p");
  var p1=document.createElement("p");

  var i0=document.createElement("i");
  var i1=document.createElement("i");

  perant.appendChild(div0).classList.add("card","mb-3","w-100","pe-0","rounded-2","border-info");
  div0.appendChild(div1).classList.add("row","g-0");
  div1.appendChild(div2).classList.add("col-md-12");
  div2.appendChild(div3).classList.add("card-body","p-0");
  div3.appendChild(div4).classList.add("row");
  div3.appendChild(div9).classList.add("card-footer","d-flex", "justify-content-around","py-2");
  div4.appendChild(div5).classList.add("p-4","col-sm-8");
  div4.appendChild(div6).classList.add("col-sm-4","d-flex","justify-content-center","align-items-center");

  div5.appendChild(div7);
  div5.appendChild(span0).classList.add("text-muted","small");
  div5.appendChild(p0).classList.add("card-text","mt-3","p-style");
  div7.setAttribute("id","rateYo"+count);
  div7.setAttribute("data-rateyo-read-only","true");
  span0.innerHTML="Over All Raiting";
  p0.innerHTML=content;

  div6.appendChild(div8).classList.add("text-center");
  div8.appendChild(p1);
  div8.appendChild(span1).classList.add("text-muted","mt-5");
  p1.appendChild(span2).classList.add("rate","p-2","border","rounded-3");
  span1.innerHTML="Doctor Raiting";
  span2.innerHTML=rate;
  div9.appendChild(div10);
  div9.appendChild(div11);
  var arrdta= date.split("T");
  div10.appendChild(i0).classList.add("fa-solid", "fa-calendar-check","px-2" );
  div10.appendChild(span3).classList.add("card-text","my-2","p-style");
  div11.appendChild(i1).classList.add("fa-solid", "fa-clock","px-2");
  div11.appendChild(span4).classList.add("card-text","my-2","p-style");
  span3.innerHTML=arrdta[0];
  span4.innerHTML=arrdta[1];

   var rat="#rateYo"+count;
        $(function () {
          $(rat).rateYo({
            rating: rate,
            readOnly: true,
            starWidth: "23px",
          });
          
        });
        //Getter
         var normalFill = $(rat).rateYo("option", "rating");
         
         // Setter
         $(rat).rateYo("option", "readOnly", false); //returns a jQuery Element
   count++;
}
function reservation(image,name,phone,date){
    var reservationn=document.getElementById("Allreservations");
    var div0=document.createElement("div");
    var div1=document.createElement("div");
    var div2=document.createElement("div");
    var div3=document.createElement("div");
    var div4=document.createElement("div");
    var div5=document.createElement("div");
    var div6=document.createElement("div");
    var div7=document.createElement("div");
    var div8=document.createElement("div");
    var div9=document.createElement("div");
    var div10=document.createElement("div");

    var img=document.createElement("img");
    var h5=document.createElement("h5");
    var span0=document.createElement("apan");
    var span1=document.createElement("apan");
    var span2=document.createElement("apan");
    var span3=document.createElement("apan");
    var span4=document.createElement("apan");
    var a0=document.createElement("a");
    var a1=document.createElement("a");
    var i0=document.createElement("i");
    var i1=document.createElement("i");
    var i2=document.createElement("i");
    var i3=document.createElement("i");

    reservationn.appendChild(div0).classList.add("my-3");
    div0.appendChild(div1).classList.add("card" ,"border" ,"border-info", "rounded-3");
    div1.appendChild(div2).classList.add("row" ,"g-0" ,"p-3");
    div1.appendChild(div3).classList.add("card-footer", "d-flex", "justify-content-around");
    div2.appendChild(div4).classList.add("col-md-2" ,"p-3");
    div2.appendChild(div5).classList.add("col-md-8");
    div2.appendChild(div9).classList.add("col-md-2","h-100","d-flex","align-items-end");
    div4.appendChild(img).classList.add("img-fluid" ,"w-100","h-100","rounded-circle", "border" ,"border-info");
    img.src=image;
    div5.appendChild(div6).classList.add("card-body" ,"ps-0");
    div6.appendChild(h5).classList.add("card-title" ,"name");
    div6.appendChild(span0).classList.add("text-muted");
    h5.innerHTML=name;
    span0.setAttribute("id","spacialist");
    span0.innerHTML=phone;
    div3.appendChild(div7);
    div3.appendChild(div8);
    div7.appendChild(i0).classList.add("fa-solid", "fa-calendar-check" );
    var arrdate = date.split(" ");
    div7.appendChild(span1).innerHTML=" "+arrdate[0];
    div8.appendChild(i1).classList.add("fa-solid", "fa-clock");
    div8.appendChild(span2).innerHTML=" "+arrdate[1];
    div9.appendChild(div10).classList.add("row","card-body","ps-0","h-100");
    div10.appendChild(span3).classList.add("col-md-6");
    div10.appendChild(span4).classList.add("col-md-6");
    span3.appendChild(a0).classList.add("color-i");
    a0.href="chat.html"
    a0.appendChild(i2).classList.add("fa-solid","fa-comments","border","border-info","fs-4","p-2");
    span4.appendChild(a1).classList.add("color-i");
    a1.appendChild(i3).classList.add("fa-solid","fa-video","ms-2","border","border-info","fs-4","p-2");

}
 ////////////////////////comments

var idDoctor=localStorage.getItem("uIdDoctor");
let commentCollectionRef = query(collection(db, `doctor/${idDoctor}/comments`),orderBy("createdAt"));  
  onSnapshot(commentCollectionRef, { includeMetadataChanges: true }, (snapshot) => {
  snapshot.docChanges().forEach((item) => {
     // let datetime = item.doc.data().createdAt.toDate();
      data_of_comments(item.doc.data().rate,item.doc.data().comment,item.doc.data().createdAt);
      const source = snapshot.metadata.fromCache ? "local cache" : "server";
  });
});

///////////////////////////reservation
let arr=[],arrdata=[];
let resrvCollectionRef = collection(db, `doctor/${idDoctor}/reservation`);  
const GroupDocs = await getDocs(resrvCollectionRef);
GroupDocs.forEach(async(item) =>{
    arr.push(item.id);
});


for(var i=0;i<arr.length;arr++){
    let resrvCollectionRefdata = collection(db, `reservation`);  
    const GroupDocsdata = await getDocs(resrvCollectionRefdata);
    GroupDocsdata.forEach(async(item) =>{
      if(item.id==arr[i]){
        localStorage.setItem("date_res",item.data().date);
        arrdata.push(item.data().patientId);
      }
    });
}

for(var j=0;j<arrdata.length;j++){
  let resrvCollectionRefdataaa = collection(db, `patient`);  
    const GroupDocsdataaa = await getDocs(resrvCollectionRefdataaa);
    GroupDocsdataaa.forEach(async(item) =>{
      if(item.id==arrdata[i])
        reservation(item.data().image,item.data().fullName,item.data().phone,localStorage.getItem("date_res"));
    });
}

</script> 

    <script src="js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/rateYo/2.3.2/jquery.rateyo.min.js"></script>    
    </body>
</html>